<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Truly Price Tag Label Tool</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>
<body class="p-4 bg-light">
  <div class="container">
    <h2>üõçÔ∏è Truly Market - Price Tag Label Tool</h2>

    <!-- Search UI -->
    <div class="input-group my-3">
      <input type="text" id="searchInput" class="form-control" placeholder="Enter product name or SKU" />
      <button class="btn btn-outline-primary" onclick="searchProducts()">Search</button>
    </div>

    <!-- Product Table -->
    <table class="table table-bordered" id="productTable">
      <thead class="table-light">
        <tr>
          <th>SKU</th>
          <th>English Name</th>
          <th>Chinese Name (editable)</th>
          <th>Price</th>
          <th>Add</th>
        </tr>
      </thead>
      <tbody id="productList">
        <tr><td colspan="5">Please search a product.</td></tr>
      </tbody>
    </table>

    <div class="text-end mt-4">
      <button class="btn btn-primary" onclick="generatePDF()">Generate PDF</button>
    </div>
  </div>

  <!-- JS Logic -->
  <script>
    let allProducts = [];
    let printList = [];

    function searchProducts() {
      const keyword = document.getElementById("searchInput").value.trim();
      if (!keyword) return alert("Please enter a keyword to search.");

      document.getElementById("productList").innerHTML =
        `<tr><td colspan="5">Searching for "${keyword}"...</td></tr>`;

      fetch(`/.netlify/functions/search-products?keyword=${encodeURIComponent(keyword)}`)
        .then(res => res.json())
        .then(products => {
          allProducts = products.map(product => {
            const variant = product.variants[0];
            return {
              id: product.id,
              sku: variant.sku || variant.id,
              title: product.title,
              price: variant.price,
              chineseName: "",
            };
          });
          renderProducts(allProducts);
        })
        .catch(err => {
          document.getElementById("productList").innerHTML =
            `<tr><td colspan="5" class="text-danger">Search failed: ${err.message}</td></tr>`;
        });
    }

    function renderProducts(data) {
      const tbody = document.getElementById("productList");
      tbody.innerHTML = "";
      if (data.length === 0) {
        tbody.innerHTML = `<tr><td colspan="5">No products found.</td></tr>`;
        return;
      }

      data.forEach(product => {
        const inputId = `cn-${product.id}`;
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${product.sku}</td>
          <td>${product.title}</td>
          <td><input type="text" class="form-control form-control-sm" id="${inputId}" placeholder="Ëº∏ÂÖ•‰∏≠ÊñáÂêçÁ®±"></td>
          <td>$${product.price}</td>
          <td><button class="btn btn-sm btn-success" onclick="addToPrintList('${product.id}', '${inputId}')">Add</button></td>
        `;
        tbody.appendChild(row);
      });
    }

    function addToPrintList(id, inputId) {
      const cnName = document.getElementById(inputId).value.trim();
      const product = allProducts.find(p => p.id == id);
      if (!product) return;
      printList.push({ ...product, chineseName: cnName });
      alert(`Added "${product.title}" to print list.`);
    }

    function generatePDF() {
      if (printList.length === 0) {
        alert("No products in print list.");
        return;
      }
      console.log("üñ®Ô∏è PDF generation coming next with:", printList);
      alert("PDF generation will be implemented next.");
    }
  </script>
</body>
</html>
